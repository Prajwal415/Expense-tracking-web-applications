<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Scan Bill ‚Äî Expense Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script>
    (function() {
      const theme = localStorage.getItem("appTheme") || "light";
      document.documentElement.setAttribute("data-theme", theme);
    })();
  </script>

  <!-- Tesseract for OCR -->
  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <!-- Your ML engine -->
  <script src="receipt-ml-engine.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Html5Qrcode for QR Scanning -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #e5e7eb;
      --accent: #3f67e6;
      --accent-soft: #e0e7ff;
      --accent-dark: #2949c0;
      --danger: #ef4444;
      --muted: #6b7280;
      --text: #0b2340;
      --text-soft: #9ca3af;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      --radius-lg: 18px;
      --radius-sm: 10px;
      --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    :root[data-theme="dark"] {
      --bg: #020617;
      --card: #0f172a;
      --border: #1e293b;
      --accent: #60a5fa;
      --accent-soft: #0b1120;
      --accent-dark: #2563eb;
      --danger: #f97373;
      --muted: #9ca3af;
      --text: #ffffff;
      --text-soft: #6b7280;
      --shadow: 0 10px 40px rgba(15, 23, 42, 0.7);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, rgba(96,165,250,0.18), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(139,92,246,0.18), transparent 55%),
                  var(--bg);
      min-height: 100vh;
      color: var(--text);
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    header h1 {
      font-size: 26px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span {
      font-size: 28px;
    }

    .back-link {
      text-decoration: none;
      color: var(--accent);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(148,163,184,0.12);
      border: 1px solid rgba(148,163,184,0.25);
      font-size: 13px;
    }

    .back-link:hover {
      background: rgba(148,163,184,0.2);
    }

    .settings-pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .settings-pill span {
      font-weight: 600;
      color: var(--accent);
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 18px 18px 20px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(96,165,250,0.12), transparent 60%);
      pointer-events: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-weight: 700;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .muted {
      font-size: 12px;
      color: var(--muted);
    }

    .video-box {
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.4);
      background: radial-gradient(circle at center, rgba(15,23,42,0.4), rgba(15,23,42,0.9));
      margin-top: 10px;
      aspect-ratio: 1;
      width: 100%;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    video {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      background: #000;
    }

    .mirror-video {
      transform: scaleX(-1);
    }

    .video-overlay-text {
      position: absolute;
      left: 12px;
      bottom: 10px;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.8);
      color: #e5e7eb;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mode-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }

    .mode-tab {
      padding: 8px 14px;
      border-radius: 999px;
      background: transparent;
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      transition: all var(--transition);
    }

    .mode-tab.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
    }

    .mode-content {
      display: none;
    }

    .mode-content.active {
      display: block;
    }

    .controls-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border: 0;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition), color var(--transition);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18);
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: white;
    }

    .btn-secondary {
      background: rgba(148,163,184,0.14);
      color: var(--text);
      box-shadow: none;
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px dashed rgba(148,163,184,0.6);
      box-shadow: none;
    }

    .btn:active {
      transform: scale(0.96);
    }

    .status-pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 9px;
      background: rgba(15,23,42,0.08);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 8px;
    }

    .status-pill span {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 5px rgba(34,197,94,0.25);
    }

    .status-pill.error span {
      background: var(--danger);
      box-shadow: 0 0 0 5px rgba(248,113,113,0.25);
    }

    .badges-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .badge-soft {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(148,163,184,0.12);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-soft strong {
      color: var(--accent);
    }

    .section-title {
      margin-top: 10px;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .preview-box {
      margin-top: 10px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.02);
      padding: 10px 12px;
      font-size: 13px;
      max-height: 150px;
      overflow-y: auto;
    }

    .preview-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 10px;
      font-size: 13px;
    }

    .preview-row span.label {
      color: var(--muted);
    }

    .preview-amount {
      font-weight: 700;
      color: var(--accent);
    }

    .preview-category {
      font-weight: 600;
    }

    .chip-warning {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(250,204,21,0.12);
      color: #facc15;
      border: 1px solid rgba(234,179,8,0.4);
    }

    .moment-gallery {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
    }

    .moment-item {
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.35);
      background: var(--card);
      display: flex;
      flex-direction: column;
      min-height: 140px;
      position: relative;
      transition: transform var(--transition), box-shadow var(--transition);
    }

    .moment-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .moment-item img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      display: block;
      background: #000;
    }

    .delete-moment-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
      font-size: 14px;
    }

    .moment-item:hover .delete-moment-btn {
      opacity: 1;
    }

    .moment-meta {
      padding: 6px 8px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .moment-actions {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    .moment-actions button {
      flex: 1;
      border-radius: 999px;
      border: 0;
      font-size: 10px;
      padding: 4px 0;
      cursor: pointer;
      background: rgba(148,163,184,0.18);
      color: var(--text);
    }

    .moment-actions button.primary {
      background: rgba(96,165,250,0.2);
      color: var(--accent);
      font-weight: 600;
    }

    .currency-pill {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(148,163,184,0.12);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* Larger button for easier mobile tapping */
    #captureMomentBtn {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      margin-top: 8px;
    }

    /* Scan & Pay Styles */
    .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 999; display: none; backdrop-filter: blur(4px); animation: fadeIn 0.2s ease-out; }
    .overlay.active { display: block; }
    .modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: var(--card); padding: 24px; border-radius: 16px; box-shadow: var(--shadow); z-index: 1000; width: 90%; max-width: 400px; display: none; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); border: 1px solid var(--border); }
    .modal.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translate(-50%, -40%); } to { opacity: 1; transform: translate(-50%, -50%); } }
    .modal h4 { margin: 0 0 16px 0; font-size: 20px; font-weight: 700; color: var(--text); }
    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .modal-actions button { flex: 1; }
    .form-input { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1.5px solid var(--border); margin-bottom: 12px; font-size: 16px; background: var(--card); color: var(--text); }
    .form-input:focus { outline: none; border-color: var(--accent); }
    .pay-app-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 15px; margin-bottom: 5px; }
    .pay-app-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px 4px; cursor: pointer; transition: all 0.2s; height: 100%; }
    .pay-app-btn:hover { background: var(--accent-soft); border-color: var(--accent); transform: translateY(-2px); }
    .pay-app-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .pay-app-name { font-size: 11px; font-weight: 600; color: var(--text); }
    .recent-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(148,163,184,0.05); border-radius: 10px; border: 1px solid var(--border); margin-bottom: 8px; }
    .recent-info div:first-child { font-weight: 600; font-size: 14px; }
    .recent-info div:last-child { font-size: 11px; color: var(--muted); }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 10000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; opacity: 0; pointer-events: none; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <a class="back-link" href="dashboard.html" data-i18n="backToDashboard">‚Üê Back to Dashboard</a>
      <h1 data-i18n="scanHeader"><span>üì∑</span> Scan & Capture</h1>
    </div>
    <div class="settings-pill">
      Theme: <span id="themeLabel">Light</span> ¬∑ Currency: <span id="currencyLabel">INR</span>
    </div>
  </header>

  <!-- ============ COMBINED CARD: BILL + MOMENT ============ -->
  <section class="card">
    <!-- MODE TABS -->
    <div class="mode-tabs">
      <button class="mode-tab" onclick="switchMode('bill')" data-i18n="tabBill">üßæ Capture Bill</button>
      <button class="mode-tab" onclick="switchMode('moment')" data-i18n="tabMoment">‚ú® Capture Moment</button>
      <button class="mode-tab active" onclick="switchMode('qr')">üì± Scan QR</button>
    </div>

    <!-- ============ BILL MODE ============ -->
    <div id="billMode" class="mode-content">
      <div class="card-header">
        <div>
          <div class="card-title">üßæ Capture Bill <span class="chip">Bill mode</span></div>
          <div class="muted"></div>
        </div>
        <div class="currency-pill">
          Currency: <strong id="billCurrencyDisplay">INR</strong>
        </div>
      </div>

      <div class="video-box">
        <video id="billVideo" autoplay playsinline></video>
        <div class="video-overlay-text">
          <span id="billCameraInfo">Camera: not started</span>
        </div>
      </div>

      <div class="controls-row">
        <button class="btn btn-primary" id="startBillBtn">‚ñ∂ Start Bill Camera</button>
        <button class="btn btn-secondary" id="switchBillCamBtn">üîÑ Switch Camera</button>
        <button class="btn btn-secondary" id="captureBillBtn">üì∏ Capture Bill</button>
        <button class="btn btn-secondary" id="importBillLabel">üìÅ Import Bill</button>
        <input type="file" id="importBillFile" accept="image/*" />
      </div>

      <div class="status-pill" id="billStatus">
        <span></span>Camera not started yet.
      </div>

      <div class="section-title">Extracted result</div>
      <div class="preview-box" id="billPreview">
        <div class="muted">No bill processed yet. Capture a bill to see amount, category & text.</div>
      </div>

      <div class="controls-row" style="margin-top: 10px;">
        <button class="btn btn-primary" id="saveBillToExpensesBtn" disabled>üíæ Save to Expenses</button>
        <button class="btn btn-ghost" id="clearBillPreviewBtn">Clear</button>
      </div>
    </div>

    <!-- ============ MOMENT MODE (MIRRORED) ============ -->
    <div id="momentMode" class="mode-content">
      <div class="card-header">
        <div>
          <div class="card-title">‚ú® Capture the Moment</div>
          <div class="muted"></div>
        </div>
      </div>

      <div class="video-box">
        <video id="momentVideo" autoplay playsinline></video>
        <div class="video-overlay-text">
          <span id="momentCameraInfo">Camera: not started</span>
        </div>
      </div>

      <div class="controls-row">
        <button class="btn btn-primary" id="startMomentBtn">‚ñ∂ Start Moment Camera</button>
        <button class="btn btn-secondary" id="switchMomentCamBtn">üîÑ Change Camera</button>
        <button class="btn btn-secondary" id="toggleMirrorBtn">Mirror</button>
        <button class="btn btn-secondary" id="captureMomentBtn">üì∏ Capture the Moment</button>
      </div>

      <div class="badges-row">
        <div class="badge-soft">Bill mode uses <strong>rear camera</strong> (no mirror)</div>
      </div>

      <div class="section-title" style="display:flex; justify-content:space-between; align-items:center;">
        <span data-i18n="savedMoments">Saved moments</span>
        <button class="btn btn-danger" id="deleteAllMomentsBtn" style="padding: 4px 10px; font-size: 11px; height: auto; display: none;">Delete All Moments</button>
      </div>
      <div class="preview-box" style="max-height:none;">
        <div class="moment-gallery" id="momentGallery"></div>
        <div id="noMomentsText" class="muted">No moments yet. Capture one to save it in this device.</div>
      </div>
    </div>

    <!-- ============ QR MODE ============ -->
    <div id="qrMode" class="mode-content active">
      <div class="card" style="box-shadow:none; border:none; padding:0; margin:0;">
        <button class="btn btn-secondary" onclick="openQrScanner('direct')" style="padding: 16px; font-size: 16px; width: 100%; background: var(--accent-soft); color: var(--accent); border: 1px solid var(--accent);">
          <span data-i18n="scanDirectUPI">üì± Scan & Pay (Direct App)</span>
        </button>

        <button class="btn btn-secondary" onclick="document.getElementById('qrInputFile').click()" style="margin-top: 12px; padding: 12px; font-size: 14px; width: 100%; background: var(--accent-soft); color: var(--accent); border: 1px solid var(--accent);">
          <span>üñºÔ∏è Import QR from Gallery</span>
        </button>
        <input type="file" id="qrInputFile" accept="image/*" style="display:none" onchange="handleFileScan(this)">
        
        <div style="margin-top: 15px; text-align: center; font-size: 13px; color: var(--muted);">
          or <a href="#" onclick="openPayModal(); return false;" style="color: var(--accent); text-decoration: none; font-weight: 600;">Enter UPI ID Manually</a>
        </div>
      </div>

      <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--text); margin-top: 20px;">Recent Transactions</h3>
      <div id="recentPaymentsList">
        <div style="text-align: center; padding: 20px; color: var(--muted); font-size: 13px;">No recent payments</div>
      </div>
    </div>
  </section>

  <!-- CANVAS (hidden) -->
  <canvas id="captureCanvas" style="display:none;"></canvas>

  <!-- Pay Modal -->
  <div class="overlay" id="overlay"></div>
  <div class="modal" id="payModal">
    <h4>üí∏ Make Payment</h4>
    <div>
      <label for="payAmount">Amount (‚Çπ)</label>
      <input type="number" id="payAmount" class="form-input" placeholder="‚Çπ0" style="font-size: 24px; font-weight: bold; text-align: center; color: var(--accent);">
      
      <label for="payTo">Payee Name</label>
      <input type="text" id="payTo" class="form-input" placeholder="Name, Shop, or ID">
      
      <label for="payUpiId">Payee UPI ID</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="payUpiId" class="form-input" placeholder="e.g. merchant@okicici" style="margin-bottom: 12px;">
        <button type="button" onclick="toggleUpiFavorite()" id="favUpiBtn" style="height: 48px; width: 48px; background:transparent; border:1px solid var(--border); border-radius:10px; cursor:pointer; font-size:20px; color:var(--warning);" title="Save as Favorite">‚òÜ</button>
      </div>
      <div id="upiFavoritesList" style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom: 12px;"></div>

      <label for="payCategory">Category</label>
      <select id="payCategory" class="form-input">
        <option value="Food">Food</option>
        <option value="Shopping">Shopping</option>
        <option value="Travel">Travel</option>
        <option value="Utilities">Utilities</option>
        <option value="Medical">Medical</option>
        <option value="Entertainment">Entertainment</option>
        <option value="Other">Other</option>
      </select>

      <!-- Advanced Merchant Params (Hidden by default) -->
      <div style="margin-top: 12px;">
        <button type="button" class="btn btn-ghost" onclick="toggleAdvancedParams()" style="padding: 8px; font-size: 12px; width: 100%; border: 1px dashed var(--border); color: var(--muted);">
          üîß Show Merchant Details (MC/TR)
        </button>
        <div id="advancedParams" style="display: none; margin-top: 10px; padding: 12px; background: var(--bg); border-radius: 10px; border: 1px solid var(--border);">
          <label for="payMc" style="font-size: 11px;">Merchant Code (mc)</label>
          <input type="text" id="payMc" class="form-input" style="font-size: 13px; padding: 8px; margin-bottom: 8px;" placeholder="Optional">
          
          <label for="payTr" style="font-size: 11px;">Transaction Ref (tr)</label>
          <input type="text" id="payTr" class="form-input" style="font-size: 13px; padding: 8px; margin-bottom: 0;" placeholder="Optional">
        </div>
      </div>

      <!-- App Selection Grid (Hidden by default) -->
      <div id="paymentAppsSection" style="display:none; margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px;">
        <label style="margin-bottom: 8px;">Select App to Pay</label>
        <div class="pay-app-grid">
        <button class="pay-app-btn" onclick="payWithApp('navi')">
            <div class="pay-app-icon" style="background:#00d29b; color:white; font-family: sans-serif; font-weight: bold;">
              N
            </div>
            <span class="pay-app-name">NAVI</span>
          </button>
          <button class="pay-app-btn" onclick="payWithApp('gpay')">
          <div class="pay-app-icon" style="background:#fff; border:1px solid #eee;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px"><path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6.19c4.51-4.18 7.09-11.15 7.09-17.84z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-3.11-.76-4.77s.27-3.32.76-4.55l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.9l7.97-6.31z"/><path fill="#EA4335" d="M24 48c6.48 0 11.95-2.13 15.89-5.81l-7.73-6.19c-2.14 1.44-4.9 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
            </div>
            <span class="pay-app-name">GPay</span>
          </button>
          <button class="pay-app-btn" onclick="payWithApp('phonepe')">
            <div class="pay-app-icon" style="background:#5f259f; color:white;">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            </div>
            <span class="pay-app-name">PhonePe</span>
          </button>
          <button class="pay-app-btn" onclick="payWithApp('paytm')">
            <div class="pay-app-icon" style="background:#00baf2; color:white;">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
            </div>
            <span class="pay-app-name">Paytm</span>
          </button>
          <button class="pay-app-btn" onclick="payWithApp('default')">
            <div class="pay-app-icon" style="background:var(--accent); color:white;">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </div>
            <span class="pay-app-name">Other</span>
          </button>
        </div>
      </div>

    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" id="payBtnAction" onclick="handlePaymentAction()">Pay Now</button>
      <button class="btn btn-secondary" onclick="closePayModal()">Cancel</button>
    </div>
  </div>

  <!-- QR Scanner Modal -->
  <div class="modal" id="qrScannerModal">
    <h4>üì∑ Scan UPI QR</h4>
    <div id="qr-reader" style="width: 100%; border-radius: 8px; overflow: hidden;"></div>
    <p style="text-align: center; font-size: 12px; color: var(--muted); margin-top: 10px;">Point your camera at a UPI QR code</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeQrScanner()">Close</button>
    </div>
  </div>

  <!-- Payment Confirmation Modal -->
  <div class="modal" id="paymentConfirmModal" style="text-align: center;">
    <div style="font-size: 48px; margin-bottom: 10px;">üì±</div>
    <h4>Payment Status</h4>
    <p style="font-size: 14px; color: var(--muted); margin-bottom: 20px;">You just returned from the payment app.</p>
    <div class="modal-actions" style="flex-direction: column; gap: 10px;">
      <button class="btn btn-primary" onclick="confirmPaymentSuccess()">‚úÖ Payment Successful</button>
      <button class="btn btn-secondary" onclick="closePaymentConfirmModal()" style="background: rgba(239,68,68,0.1); color: var(--danger);">‚ùå Failed / Cancelled</button>
    </div>
  </div>

  <!-- Payment Success Overlay -->
  <div id="paymentSuccessOverlay" style="position: fixed; inset: 0; background: #10b981; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; animation: fadeIn 0.3s ease-out;">
    <div style="background: white; border-radius: 50%; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
      <span style="font-size: 40px;">‚úÖ</span>
    </div>
    <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 10px;">Payment Successful!</h2>
    <p id="paymentSuccessMsg" style="font-size: 18px; opacity: 0.9;">‚Çπ0 paid</p>
  </div>

  <!-- Hidden div for file scanning -->
  <div id="file-qr-reader" style="display:none;"></div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>
</div>

<script>
  // =====================================================
  // SETTINGS / THEME / CURRENCY
  // =====================================================
  const SETTINGS_KEY = "userSettings";
  const EXPENSES_KEY = "userExpenses";
  const MOMENTS_KEY = "scanBillMoments";
  // Fix: Allow connection from IP addresses (mobile) by checking port only
  const API_BASE = (window.location.port && window.location.port !== '5003')
    ? `http://${window.location.hostname}:5003` 
    : '';
  const API_URL = `${API_BASE}/api`;

  const CURRENCY_SYMBOLS = {
    INR: "‚Çπ",
    USD: "$",
    EUR: "‚Ç¨",
    GBP: "¬£",
    JPY: "¬•",
    AUD: "A$",
    CAD: "C$"
  };

  let globalSettings = {};

  async function applySettingsToPage() {
    try {
      const token = localStorage.getItem('token');
      const res = await fetch(`${API_URL}/preferences`, { headers: { 'Authorization': `Bearer ${token}` } });
      if (res.ok) {
        globalSettings = await res.json();
      }
    } catch (e) { console.error("Failed to load settings", e); }

    const theme = localStorage.getItem("appTheme") || "light";
    const currency = globalSettings.currency || "INR";

    document.getElementById("themeLabel").innerText = theme === "dark" ? "Dark" : "Light";
    document.getElementById("currencyLabel").innerText = currency;
    document.getElementById("billCurrencyDisplay").innerText = currency;
  }

  applySettingsToPage();

  function getActiveCurrency() {
    return globalSettings.currency || "INR";
  }

  function getCurrencySymbol() {
    const c = getActiveCurrency();
    return CURRENCY_SYMBOLS[c] || c + " ";
  }

  // =====================================================
  // MODE SWITCHING
  // =====================================================
  function switchMode(mode) {
    const tabs = document.querySelectorAll(".mode-tab");
    const contents = document.querySelectorAll(".mode-content");
    
    tabs.forEach(t => t.classList.remove("active"));
    contents.forEach(content => content.classList.remove("active"));
    
    if (mode === "bill") {
      tabs[0].classList.add("active");
      document.getElementById("billMode").classList.add("active");
      if (typeof stopQrScanner === 'function') stopQrScanner();
    } else if (mode === "moment") {
      tabs[1].classList.add("active");
      document.getElementById("momentMode").classList.add("active");
      if (typeof stopQrScanner === 'function') stopQrScanner();
    } else if (mode === "qr") {
      if(tabs[2]) tabs[2].classList.add("active");
      document.getElementById("qrMode").classList.add("active");
      if (typeof stopCurrentStream === 'function') stopCurrentStream();
    }
  }

  window.switchMode = switchMode;

  // =====================================================
  // STORAGE MANAGER
  // =====================================================
  class StorageManager {
    static getHeaders() {
      const token = localStorage.getItem('token');
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

    static async addExpense(expense) {
      const mode = localStorage.getItem('storageMode') || 'mongodb';
      if (mode === 'local') {
        const expenses = JSON.parse(localStorage.getItem('userExpenses') || '[]');
        const newExpense = { ...expense, _id: 'loc_' + Date.now(), id: 'loc_' + Date.now() };
        expenses.push(newExpense);
        localStorage.setItem('userExpenses', JSON.stringify(expenses));
        return newExpense;
      }
      try {
        const token = localStorage.getItem('token');
        if (!token) throw new Error("No login token found");

        const res = await fetch(`${API_URL}/expenses`, {
          method: 'POST',
          headers: this.getHeaders(),
          body: JSON.stringify(expense)
        });
        if (!res.ok) throw new Error(`Server error: ${res.status}`);
        return await res.json();
      } catch (error) {
        console.error('Error saving expense:', error);
        alert(`Failed to save expense to server: ${error.message}`);
        throw error;
      }
    }

    static async getMoments() {
      const mode = localStorage.getItem('storageMode') || 'mongodb';
      if (mode === 'local') {
        return JSON.parse(localStorage.getItem(MOMENTS_KEY) || '[]');
      }
      try {
        const res = await fetch(`${API_URL}/moments`, {
          headers: this.getHeaders()
        });
        if (res.ok) return await res.json();
        return [];
      } catch (e) {
        console.error('Error fetching moments:', e);
        return [];
      }
    }

    static async saveMoment(moment) {
      const mode = localStorage.getItem('storageMode') || 'mongodb';
      if (mode === 'local') {
        const moments = JSON.parse(localStorage.getItem(MOMENTS_KEY) || '[]');
        if (moments.length >= 20) {
          throw new Error('Storage limit reached (20/20)');
        }
        const newMoment = { ...moment, _id: 'loc_' + Date.now(), id: 'loc_' + Date.now() };
        moments.push(newMoment);
        localStorage.setItem(MOMENTS_KEY, JSON.stringify(moments));
        return newMoment;
      }
      try {
        const res = await fetch(`${API_URL}/moments`, {
          method: 'POST',
          headers: this.getHeaders(),
          body: JSON.stringify(moment)
        });
        if (res.ok) return await res.json();
        const err = await res.json();
        throw new Error(err.message || 'Failed to save moment');
      } catch (e) {
        console.error('Error saving moment:', e);
        if (e.message === 'Failed to fetch') {
          throw new Error(`Connection failed to ${API_URL}. Check if server is running.`);
        }
        throw e;
      }
    }

    static async deleteAllMoments() {
      const mode = localStorage.getItem('storageMode') || 'mongodb';
      if (mode === 'local') {
        localStorage.removeItem(MOMENTS_KEY);
        return;
      }
      try {
        const res = await fetch(`${API_URL}/moments`, {
          method: 'DELETE',
          headers: this.getHeaders()
        });
        if (!res.ok) throw new Error('Failed to delete all moments');
      } catch (e) {
        console.error('Error deleting all moments:', e);
        throw e;
      }
    }

    static async deleteMoment(id) {
      const mode = localStorage.getItem('storageMode') || 'mongodb';
      if (mode === 'local') {
        let moments = JSON.parse(localStorage.getItem(MOMENTS_KEY) || '[]');
        moments = moments.filter(m => (m._id !== id && m.id !== id));
        localStorage.setItem(MOMENTS_KEY, JSON.stringify(moments));
        return;
      }
      try {
        const res = await fetch(`${API_URL}/moments/${id}`, {
          method: 'DELETE',
          headers: this.getHeaders()
        });
        if (!res.ok) throw new Error('Failed to delete moment from API');
      } catch (e) {
        console.error('Error deleting moment:', e);
        throw e;
      }
    }

  }

  // =====================================================
  // CAMERA SETUP
  // =====================================================
  let currentStream = null;
  let activeMode = null;
  let billFacingMode = "environment";
  let momentFacingMode = "user";

  const billVideo = document.getElementById("billVideo");
  const momentVideo = document.getElementById("momentVideo");
  const billCameraInfo = document.getElementById("billCameraInfo");
  const momentCameraInfo = document.getElementById("momentCameraInfo");
  const billStatus = document.getElementById("billStatus");

  async function stopCurrentStream() {
    if (currentStream && currentStream.getTracks) {
      currentStream.getTracks().forEach(t => t.stop());
      currentStream = null;
    }
  }

  async function startCamera(mode) {
    try {
      await stopCurrentStream();
      activeMode = mode;

      const facingMode = mode === "bill" ? billFacingMode : momentFacingMode;

      const constraints = {
        audio: false,
        video: {
          facingMode: facingMode
        }
      };

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      currentStream = stream;

      if (mode === "bill") {
        billVideo.srcObject = stream;
        momentVideo.srcObject = null;
        billVideo.classList.remove("mirror-video");
        billCameraInfo.innerText = "Camera: " + (facingMode === "user" ? "Front" : "Back");
        billStatus.classList.remove("error");
        billStatus.innerHTML = '<span></span> Camera active. Point at the bill & tap "Capture Bill".';
      } else {
        momentVideo.srcObject = stream;
        billVideo.srcObject = null;
        
        // Default: Always mirror in Moment mode
        momentVideo.classList.add("mirror-video");
        const btn = document.getElementById("toggleMirrorBtn");
        btn.innerText = "Mirror";
        btn.classList.remove("btn-secondary");
        btn.classList.add("btn-primary");
        
        momentCameraInfo.innerText = "Camera: " + (facingMode === "user" ? "Front" : "Back");
      }
    } catch (err) {
      console.error("Camera error:", err);
      if (mode === "bill") {
        billStatus.classList.add("error");
        billStatus.innerHTML = '<span></span> Cannot access camera. Check permissions.';
      } else {
        momentCameraInfo.innerText = "Camera error. Check permissions.";
      }
    }
  }

  function switchBillCamera() {
    billFacingMode = (billFacingMode === "environment") ? "user" : "environment";
    if (activeMode === "bill") startCamera("bill");
  }

  function switchMomentCamera() {
    momentFacingMode = (momentFacingMode === "environment") ? "user" : "environment";
    if (activeMode === "moment") startCamera("moment");
  }

  // =====================================================
  // BILL CAPTURE + OCR
  // =====================================================
  const canvas = document.getElementById("captureCanvas");
  const billPreview = document.getElementById("billPreview");
  const saveBillBtn = document.getElementById("saveBillToExpensesBtn");
  const clearBillPreviewBtn = document.getElementById("clearBillPreviewBtn");

  let lastBillResult = null;

  function setBillPreviewLoading() {
    billPreview.innerHTML = `
      <div class="muted">Processing receipt with OCR...</div>
      <div class="status-pill" style="margin-top:6px;">
        <span></span> This may take a few seconds depending on image quality.
      </div>
    `;
  }

  function renderBillPreview(result) {
    if (!result) {
      billPreview.innerHTML = `<div class="muted">No bill data yet.</div>`;
      saveBillBtn.disabled = true;
      return;
    }

    const symbol = getCurrencySymbol();
    const amountStr = result.amount != null ? symbol + result.amount.toLocaleString("en-IN") : "‚Äî";
    const categoryStr = result.category || "Unknown";

    const warn = (!result.category || result.categoryConfidence < 0.5 || !result.amount);
    const warnHtml = warn
      ? `<span class="chip-warning">Low confidence ‚Äî please double-check before saving.</span>`
      : "";

    billPreview.innerHTML = `
      <div class="preview-row">
        <span class="label">Amount:</span>
        <span class="preview-amount">${amountStr}</span>
      </div>
      <div class="preview-row">
        <span class="label">Category:</span>
        <span class="preview-category">${categoryStr}</span>
      </div>
      <div class="preview-row">
        <span class="label">Confidence:</span>
        <span>${(result.categoryConfidence * 100).toFixed(1)}% (category), ${(result.amountConfidence * 100).toFixed(1)}% (amount)</span>
      </div>
      <div style="margin-top:6px;">${warnHtml}</div>
      <div style="margin-top:8px;font-size:12px;color:var(--text-soft);">
        <strong>Detected Text (snippet):</strong><br/>
        ${result.rawText.slice(0, 350).replace(/</g,"&lt;").replace(/>/g,"&gt;")}...
      </div>
    `;

    saveBillBtn.disabled = false;
  }

  async function captureBillAndProcess() {
    if (!currentStream || activeMode !== "bill") {
      billStatus.classList.add("error");
      billStatus.innerHTML = '<span></span> Start the Bill Camera first.';
      return;
    }

    try {
      const video = billVideo;
      const width = video.videoWidth || 640;
      const height = video.videoHeight || 480;

      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, width, height);

      setBillPreviewLoading();

      const dataUrl = canvas.toDataURL("image/jpeg", 0.85);

      const { data: { text } } = await Tesseract.recognize(dataUrl, "eng", {
        logger: m => console.log("Tesseract:", m)
      });

      const cleanText = (text || "").trim();
      if (!cleanText) {
        billPreview.innerHTML = `<div class="muted">Unable to read text from this image. Try again with clearer bill.</div>`;
        saveBillBtn.disabled = true;
        return;
      }

      const engine = new ReceiptMLEngine();
      const mlResult = engine.processReceipt(cleanText);

      let finalCategory = mlResult.category;
      let finalCategoryConfidence = mlResult.categoryConfidence;

      if (!finalCategory && mlResult.rawScores) {
        let bestKey = null;
        let bestScore = 0;
        for (const [key, score] of Object.entries(mlResult.rawScores)) {
          if (score > bestScore) {
            bestScore = score;
            bestKey = key;
          }
        }
        if (bestKey) {
          const map = {
            food: "Food",
            medical: "Medical",
            shopping: "Shopping",
            education: "Education",
            travel: "Travel",
            rent: "Rent"
          };
          finalCategory = map[bestKey] || "Other";
          finalCategoryConfidence = Math.max(finalCategoryConfidence, bestScore / 100);
        }
      }

      const lower = cleanText.toLowerCase();
      const foodHits = (lower.match(/\b(food|restaurant|hotel|cafe|biryani|thali|pizza|burger|swiggy|zomato)\b/g) || []).length;
      if (foodHits >= 2) {
        finalCategory = "Food";
        finalCategoryConfidence = Math.max(finalCategoryConfidence, 0.8);
      }

      const result = {
        rawText: cleanText,
        amount: mlResult.amount,
        amountConfidence: mlResult.amountConfidence || 0,
        category: finalCategory,
        categoryConfidence: finalCategoryConfidence || 0,
        currency: getActiveCurrency()
      };

      lastBillResult = result;
      renderBillPreview(result);
    } catch (err) {
      console.error("Bill capture error:", err);
      billPreview.innerHTML = `<div class="muted">Error processing bill: ${err.message}. Try again.</div>`;
      saveBillBtn.disabled = true;
    }
  }

  function clearBillPreview() {
    lastBillResult = null;
    renderBillPreview(null);
  }

  async function saveBillToExpenses() {
    if (!lastBillResult || !lastBillResult.amount || !lastBillResult.category) {
      alert("No valid bill to save. Capture and process a bill first.");
      return;
    }

    const currency = lastBillResult.currency || getActiveCurrency();
    const expense = {
      amount: lastBillResult.amount,
      category: lastBillResult.category,
      note: "Scanned bill (" + currency + ")",
      description: "Scanned bill (" + currency + ")",
      title: lastBillResult.category,
      date: new Date().toISOString(),
      currency: currency,
      type: 'expense'
    };

    try {
      await StorageManager.addExpense(expense);
      alert("‚úì Saved to Expenses successfully!");
    } catch (e) {
      // Error handled in StorageManager
    }
  }

  // =====================================================
  // IMPORT BILL FROM FILE
  // =====================================================
  async function processImportedBill(file) {
    try {
      billStatus.classList.remove("error");
      billStatus.innerHTML = '<span></span> Processing imported bill...';
      setBillPreviewLoading();

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const dataUrl = e.target.result;

          const { data: { text } } = await Tesseract.recognize(dataUrl, "eng", {
            logger: m => console.log("Tesseract:", m)
          });

          const cleanText = (text || "").trim();
          if (!cleanText) {
            billPreview.innerHTML = `<div class="muted">Unable to read text from this image. Try a clearer image.</div>`;
            saveBillBtn.disabled = true;
            return;
          }

          const engine = new ReceiptMLEngine();
          const mlResult = engine.processReceipt(cleanText);

          let finalCategory = mlResult.category;
          let finalCategoryConfidence = mlResult.categoryConfidence;

          if (!finalCategory && mlResult.rawScores) {
            let bestKey = null;
            let bestScore = 0;
            for (const [key, score] of Object.entries(mlResult.rawScores)) {
              if (score > bestScore) {
                bestScore = score;
                bestKey = key;
              }
            }
            if (bestKey) {
              const map = {
                food: "Food",
                medical: "Medical",
                shopping: "Shopping",
                education: "Education",
                travel: "Travel",
                rent: "Rent"
              };
              finalCategory = map[bestKey] || "Other";
              finalCategoryConfidence = Math.max(finalCategoryConfidence, bestScore / 100);
            }
          }

          const lower = cleanText.toLowerCase();
          const foodHits = (lower.match(/\b(food|restaurant|hotel|cafe|biryani|thali|pizza|burger|swiggy|zomato)\b/g) || []).length;
          if (foodHits >= 2) {
            finalCategory = "Food";
            finalCategoryConfidence = Math.max(finalCategoryConfidence, 0.8);
          }

          const result = {
            rawText: cleanText,
            amount: mlResult.amount,
            amountConfidence: mlResult.amountConfidence || 0,
            category: finalCategory,
            categoryConfidence: finalCategoryConfidence || 0,
            currency: getActiveCurrency()
          };

          lastBillResult = result;
          renderBillPreview(result);
          billStatus.classList.remove("error");
          billStatus.innerHTML = '<span></span> Bill imported & processed successfully.';
        } catch (err) {
          console.error("Import processing error:", err);
          billPreview.innerHTML = `<div class="muted">Error processing imported bill: ${err.message}. Try again.</div>`;
          saveBillBtn.disabled = true;
        }
      };
      reader.readAsDataURL(file);
    } catch (err) {
      console.error("Import error:", err);
      billStatus.classList.add("error");
      billStatus.innerHTML = '<span></span> Error importing bill file.';
    }
  }

  document.getElementById("importBillLabel").addEventListener("click", () => {
    document.getElementById("importBillFile").click();
  });

  document.getElementById("importBillFile").addEventListener("change", (e) => {
    if (e.target.files && e.target.files[0]) {
      processImportedBill(e.target.files[0]);
    }
  });

  // =====================================================
  // CAPTURE THE MOMENT + GALLERY
  // =====================================================
  const momentGallery = document.getElementById("momentGallery");
  const noMomentsText = document.getElementById("noMomentsText");

  async function renderMoments() {
    const moments = await StorageManager.getMoments();
    momentGallery.innerHTML = "";
    if (!moments.length) {
      noMomentsText.style.display = "block";
      if(document.getElementById("deleteAllMomentsBtn")) document.getElementById("deleteAllMomentsBtn").style.display = "none";
      return;
    }
    noMomentsText.style.display = "none";
    if(document.getElementById("deleteAllMomentsBtn")) document.getElementById("deleteAllMomentsBtn").style.display = "block";

    moments
      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
      .forEach(m => {
        const d = new Date(m.createdAt);
        const dateStr = d.toLocaleDateString("en-IN");
        const timeStr = d.toLocaleTimeString("en-IN", { hour: "2-digit", minute: "2-digit" });
        const id = m._id || m.id;

        const div = document.createElement("div");
        div.className = "moment-item";
        div.innerHTML = `
          <button class="delete-moment-btn" onclick="deleteMomentHandler('${id}')" title="Delete">√ó</button>
          <img src="${m.dataUrl}" alt="Moment" />
          <div class="moment-meta">
            <div>${dateStr} ¬∑ ${timeStr}</div>
            <div class="moment-actions">
              <button class="primary" onclick="downloadMoment('${id}','jpg')">JPG</button>
              <button onclick="downloadMoment('${id}','png')">PNG</button>
              <button onclick="downloadMoment('${id}','pdf')">PDF</button>
              <button onclick="shareMoment('${id}')" title="Share to WhatsApp/Others">Share</button>
            </div>
          </div>
        `;
        momentGallery.appendChild(div);
      });
  }

  async function captureMoment() {
    if (!currentStream || activeMode !== "moment") {
      alert("Start the Moment Camera first.");
      return;
    }

    const video = momentVideo;
    const width = video.videoWidth || 640;
    const height = video.videoHeight || 480;

    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");

    if (momentVideo.classList.contains("mirror-video")) {
      ctx.save();
      ctx.translate(width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, width, height);
      ctx.restore();
    } else {
      ctx.drawImage(video, 0, 0, width, height);
    }

    const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
    
    try {
      await StorageManager.saveMoment({
        dataUrl,
        createdAt: new Date().toISOString()
      });
      await renderMoments();
    } catch (e) {
      if (e.message && (e.message.includes('Storage limit reached') || e.message.includes('limit'))) {
        await handleStorageLimit(dataUrl);
      } else {
        alert("Failed to save moment: " + e.message);
      }
    }
  }

  async function handleStorageLimit(newDataUrl) {
    try {
      const moments = await StorageManager.getMoments();
      // Sort oldest first
      moments.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
      
      if (moments.length === 0) return; // Should not happen if limit reached

      const oldest5 = moments.slice(0, 5);
      const oldest1 = moments[0];
      const idToDelete = oldest1._id || oldest1.id;

      // Notify user
      if (confirm(`Storage limit reached (20/20).\n\nDo you want to download your oldest 5 moments before the oldest one is deleted to make space?`)) {
        // User said YES: Download 5
        for (const m of oldest5) {
          triggerDownload(m.dataUrl, `moment-${m._id || m.id}.jpg`);
          await new Promise(r => setTimeout(r, 300)); // Small delay to prevent browser blocking multiple downloads
        }
      }

      // Delete oldest 1 (in both Yes/No cases to make space for the 21st)
      await StorageManager.deleteMoment(idToDelete);
      
      // Save the new one
      await StorageManager.saveMoment({
        dataUrl: newDataUrl,
        createdAt: new Date().toISOString()
      });
      
      await renderMoments();
      // alert("Oldest moment deleted to make space. New moment saved.");
      
    } catch (e) {
      console.error(e);
      alert("Error managing storage: " + e.message);
    }
  }

  function triggerDownload(dataUrl, filename) {
    const link = document.createElement("a");
    link.href = dataUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  async function deleteMomentHandler(id) {
    if (confirm("Are you sure you want to delete this moment?")) {
      try {
        await StorageManager.deleteMoment(id);
        await renderMoments();
      } catch (e) {
        alert("Failed to delete moment.");
      }
    }
  }

  async function deleteAllMomentsHandler() {
    if (confirm("Are you sure you want to delete ALL saved moments? This cannot be undone.")) {
      try {
        await StorageManager.deleteAllMoments();
        await renderMoments();
        alert("All moments deleted.");
      } catch (e) {
        alert("Failed to delete moments.");
      }
    }
  }

  async function downloadMoment(id, format) {
    const moments = await StorageManager.getMoments();
    const m = moments.find(x => (x._id || x.id) === id);
    if (!m) return;

    if (format === "jpg" || format === "png") {
      const link = document.createElement("a");
      link.href = m.dataUrl;
      link.download = "moment-" + id + "." + format;
      link.click();
    } else if (format === "pdf") {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");
      const imgProps = pdf.getImageProperties(m.dataUrl);
      const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(m.dataUrl, "JPEG", 10, 10, pdfWidth, pdfHeight);
      pdf.save("moment-" + id + ".pdf");
    }
  }

  async function shareMoment(id) {
    const moments = await StorageManager.getMoments();
    const m = moments.find(x => (x._id || x.id) === id);
    if (!m) return;

    if (navigator.share) {
      try {
        const res = await fetch(m.dataUrl);
        const blob = await res.blob();
        const file = new File([blob], "moment.jpg", { type: "image/jpeg" });
        const shareData = {
          files: [file],
          title: 'Captured Moment',
          text: 'Check out this moment I captured!'
        };
        if (navigator.canShare && navigator.canShare(shareData)) {
          await navigator.share(shareData).catch(err => console.log('Share dismissed', err));
        } else {
          alert("Your browser supports sharing but not for image files.");
        }
      } catch (e) {
        if (e.name !== 'AbortError') alert("Share failed: " + e.message);
      }
    } else {
      alert("Sharing not supported on this browser. Try opening this app on Chrome/Safari on mobile via HTTPS or localhost.");
    }
  }

  window.downloadMoment = downloadMoment;
  window.deleteMomentHandler = deleteMomentHandler;
  window.deleteAllMomentsHandler = deleteAllMomentsHandler;
  window.shareMoment = shareMoment;

  // =====================================================
  // QR SCANNER & PAY LOGIC
  // =====================================================
  let html5QrcodeScanner = null;
  let currentScanMode = 'pg'; 
  let isScanningProcessing = false;
  window.scannedUpiParams = {}; 
  let userFavorites = { upi: [] };

  // --- Favorites & Settings ---
  async function loadPaymentSettings() {
    const mode = localStorage.getItem('storageMode') || 'mongodb';
    if (mode === 'local') {
      try {
        const localFavs = JSON.parse(localStorage.getItem('favUPIs') || '[]');
        userFavorites.upi = localFavs;
      } catch {}
      return;
    }

    try {
      const token = localStorage.getItem('token');
      if (!token) return;
      const res = await fetch(`${API_URL}/settings`, { headers: { 'Authorization': `Bearer ${token}` } });
      if (res.ok) {
        const data = await res.json();
        if (data.favorites) userFavorites = data.favorites;
        if (data.recents) {
          const localRecents = JSON.parse(localStorage.getItem('recentUPIPayments') || '[]');
          const mergedMap = new Map();
          data.recents.forEach(r => mergedMap.set(r.vpa, r));
          localRecents.forEach(r => {
            if (!mergedMap.has(r.vpa)) mergedMap.set(r.vpa, r);
            else if (r.lastPaid > mergedMap.get(r.vpa).lastPaid) mergedMap.set(r.vpa, r);
          });
          const merged = Array.from(mergedMap.values()).sort((a, b) => b.lastPaid - a.lastPaid).slice(0, 10);
          localStorage.setItem('recentUPIPayments', JSON.stringify(merged));
          renderRecentPayments();
        }
      }
    } catch (e) { console.error(e); }
  }

  function getUpiFavorites() { return userFavorites.upi || []; }

  function renderUpiFavorites() {
    const list = document.getElementById('upiFavoritesList');
    if(!list) return;
    const favs = getUpiFavorites();
    list.innerHTML = '';
    favs.forEach(fav => {
      const chip = document.createElement('div');
      chip.style.cssText = 'font-size:11px; padding:6px 10px; background:var(--accent-soft); border-radius:99px; cursor:pointer; border:1px solid var(--border); display:flex; align-items:center; gap:4px; color:var(--accent); font-weight:600;';
      chip.innerHTML = `<span>${fav.name}</span>`;
      chip.onclick = () => {
        document.getElementById('payUpiId').value = fav.vpa;
        document.getElementById('payTo').value = fav.name;
        updateFavBtnState();
      };
      list.appendChild(chip);
    });
    updateFavBtnState();
  }

  function updateFavBtnState() {
    const vpa = document.getElementById('payUpiId').value.trim();
    const btn = document.getElementById('favUpiBtn');
    const favs = getUpiFavorites();
    const exists = favs.some(f => f.vpa === vpa);
    btn.innerText = exists ? '‚òÖ' : '‚òÜ';
  }

  async function saveUpiFavorites(favs) {
    const mode = localStorage.getItem('storageMode') || 'mongodb';
    userFavorites.upi = favs;
    renderUpiFavorites();
    if (mode === 'local') {
      localStorage.setItem('favUPIs', JSON.stringify(favs));
      return;
    }
    try {
      const token = localStorage.getItem('token');
      await fetch(`${API_URL}/settings/favorites`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ favorites: userFavorites })
      });
    } catch(e) { console.error("Sync failed", e); }
  }

  window.toggleUpiFavorite = async function() {
    const vpa = document.getElementById('payUpiId').value.trim();
    const name = document.getElementById('payTo').value.trim();
    if (!vpa) { alert('Enter a UPI ID first'); return; }
    let favs = getUpiFavorites();
    const idx = favs.findIndex(f => f.vpa === vpa);
    if (idx >= 0) {
      favs.splice(idx, 1);
    } else {
      if (!name) { alert('Enter Payee Name to save favorite'); return; }
      favs.push({ vpa, name });
    }
    await saveUpiFavorites(favs);
  }

  // --- Modals & Scanner ---
  window.toggleAdvancedParams = function() {
    const div = document.getElementById('advancedParams');
    const btn = document.querySelector('button[onclick="toggleAdvancedParams()"]');
    if (div.style.display === 'none') {
      div.style.display = 'block';
      btn.innerText = 'üîß Hide Merchant Details';
    } else {
      div.style.display = 'none';
      btn.innerText = 'üîß Show Merchant Details (MC/TR)';
    }
  }

  window.openPayModal = function(keepParams = false) {
    document.getElementById('payAmount').value = '';
    document.getElementById('payTo').value = '';
    document.getElementById('payUpiId').value = '';
    document.getElementById('payCategory').value = 'Food';
    document.getElementById('payMc').value = '';
    document.getElementById('payTr').value = '';
    if (!keepParams) window.scannedUpiParams = {};
    renderUpiFavorites();
    document.getElementById('paymentAppsSection').style.display = 'none';
    document.getElementById('payBtnAction').style.display = 'block';
    overlay.classList.add('active');
    document.getElementById('payModal').classList.add('active');
    setTimeout(() => document.getElementById('payAmount').focus(), 100);
  }

  window.closePayModal = function() {
    overlay.classList.remove('active');
    document.getElementById('payModal').classList.remove('active');
  }

  window.openQrScanner = function(mode = 'pg') {
    currentScanMode = mode;
    isScanningProcessing = false;
    stopCurrentStream(); // Stop bill/moment camera
    overlay.classList.add('active');
    document.getElementById('qrScannerModal').classList.add('active');
    
    if (!html5QrcodeScanner) {
      html5QrcodeScanner = new Html5Qrcode("qr-reader");
    }
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    setTimeout(() => {
      html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, (err) => {}).catch(err => {
        console.error("Error starting scanner", err);
        alert("Camera access failed");
        closeQrScanner();
      });
    }, 100);
  }

  window.closeQrScanner = function() {
    if (html5QrcodeScanner) {
      html5QrcodeScanner.stop().then(() => html5QrcodeScanner.clear()).catch(err => console.error(err));
    }
    overlay.classList.remove('active');
    document.getElementById('qrScannerModal').classList.remove('active');
  }

  function onScanSuccess(decodedText, decodedResult) {
    if (isScanningProcessing) return;
    const cleanText = decodedText.trim();
    if (cleanText.startsWith('upi://') || cleanText.includes('@')) {
      isScanningProcessing = true;
      closeQrScanner();
      let vpa = cleanText;
      let name = '';
      let amount = '';
      window.scannedUpiParams = {};
      
      if (cleanText.startsWith('upi://')) {
        try {
          const url = new URL(cleanText);
          vpa = url.searchParams.get('pa') || '';
          name = url.searchParams.get('pn') || '';
          amount = url.searchParams.get('am') || '';
          if (url.searchParams.get('mc')) window.scannedUpiParams.mc = url.searchParams.get('mc');
          if (url.searchParams.get('tr')) window.scannedUpiParams.tr = url.searchParams.get('tr');
          if (url.searchParams.get('tn')) window.scannedUpiParams.tn = url.searchParams.get('tn');
          if (url.searchParams.get('url')) window.scannedUpiParams.url = url.searchParams.get('url');
        } catch(e) { console.error("QR Parse Error", e); } 
      }

      openPayModal(true);
      document.getElementById('payUpiId').value = vpa;
      if (amount) {
        document.getElementById('payAmount').value = amount;
      } else {
        document.getElementById('payAmount').value = '';
        setTimeout(() => document.getElementById('payAmount').focus(), 300);
      }
      if (name) document.getElementById('payTo').value = decodeURIComponent(name);
      if (window.scannedUpiParams.mc) document.getElementById('payMc').value = window.scannedUpiParams.mc;
      if (window.scannedUpiParams.tr) document.getElementById('payTr').value = window.scannedUpiParams.tr;
      renderUpiFavorites();
    } else {
      alert("Not a valid UPI QR");
    }
  }

  window.handlePaymentAction = function() {
    const amount = document.getElementById('payAmount').value;
    const payee = document.getElementById('payTo').value;
    const upiId = document.getElementById('payUpiId').value;

    if (!amount || amount <= 0) { alert('Enter valid amount'); return; }
    if (!payee) { alert('Enter payee name'); return; }
    if (!upiId) { alert('Enter Payee UPI ID'); return; }

    document.getElementById('paymentAppsSection').style.display = 'block';
    document.getElementById('payBtnAction').style.display = 'none';
  }

  window.payWithApp = function(appName) {
    const amount = document.getElementById('payAmount').value.trim();
    const payee = document.getElementById('payTo').value.trim();
    const upiId = document.getElementById('payUpiId').value.trim();
    const category = document.getElementById('payCategory').value.trim();
    
    let note = `Payment to ${payee}`;
    if (window.scannedUpiParams && window.scannedUpiParams.tn) note = window.scannedUpiParams.tn;
    
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (!isMobile) { alert("UPI links require a mobile device."); return; }

    let scheme = 'upi://pay';
    if (appName === 'gpay') scheme = 'tez://upi/pay';
    if (appName === 'phonepe') scheme = 'phonepe://pay';
    if (appName === 'paytm') scheme = 'paytm://pay';
    if (appName === 'navi') scheme = 'upi://pay';

    const formattedAmount = parseFloat(amount).toFixed(2);
    let mode = '00';
    if (window.scannedUpiParams && Object.keys(window.scannedUpiParams).length > 0) mode = '01';

    let link = `${scheme}?pa=${upiId}&pn=${encodeURIComponent(payee)}&am=${formattedAmount}&cu=INR&tn=${encodeURIComponent(note)}&mode=${mode}`;
    const mc = document.getElementById('payMc').value.trim();
    const tr = document.getElementById('payTr').value.trim();
    if (mc) link += `&mc=${encodeURIComponent(mc)}`;
    if (tr) link += `&tr=${encodeURIComponent(tr)}`;
    if (window.scannedUpiParams && window.scannedUpiParams.url) link += `&url=${encodeURIComponent(window.scannedUpiParams.url)}`;

    window.pendingDirectPayment = { amount, payee, category, upiId };
    window.paymentPending = Date.now();
    closePayModal();
    window.location.href = link;
  }

  window.closePaymentConfirmModal = function() {
    overlay.classList.remove('active');
    document.getElementById('paymentConfirmModal').classList.remove('active');
    window.pendingDirectPayment = null;
  }

  window.confirmPaymentSuccess = function() {
    if (window.pendingDirectPayment) {
      document.getElementById('paymentConfirmModal').classList.remove('active');
      saveExpenseData(window.pendingDirectPayment, "Payment Recorded");
    }
  }

  async function saveExpenseData(data, customTitle) {
    const expense = {
      amount: Number(data.amount),
      category: data.category,
      note: `Paid to ${data.payee}`,
      date: new Date().toISOString(),
      currency: 'INR',
      type: 'expense'
    };
    closePayModal();
    const successOverlay = document.getElementById('paymentSuccessOverlay');
    successOverlay.querySelector('h2').innerText = customTitle || "Payment Successful!";
    document.getElementById('paymentSuccessMsg').innerText = `‚Çπ${data.amount} paid to ${data.payee}`;
    successOverlay.style.display = 'flex';

    try {
        await StorageManager.addExpense(expense);
        setTimeout(() => {
            successOverlay.style.display = 'none';
        }, 2000);
    } catch(e) {
        setTimeout(() => {
            successOverlay.style.display = 'none';
            alert('Saved locally (Network error)');
        }, 2000);
    }
    if (data.upiId) addToRecentPayments(data.payee, data.upiId);
  }

  async function addToRecentPayments(name, vpa) {
    let recents = JSON.parse(localStorage.getItem('recentUPIPayments') || '[]');
    recents = recents.filter(r => r.vpa !== vpa);
    recents.unshift({ name, vpa, lastPaid: Date.now() });
    if (recents.length > 10) recents = recents.slice(0, 10);
    localStorage.setItem('recentUPIPayments', JSON.stringify(recents));
    renderRecentPayments();
  }

  function renderRecentPayments() {
    const list = document.getElementById('recentPaymentsList');
    if(!list) return;
    const recents = JSON.parse(localStorage.getItem('recentUPIPayments') || '[]');
    if (recents.length === 0) {
      list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted); font-size: 13px;">No recent payments</div>';
      return;
    }
    list.innerHTML = '';
    recents.forEach(r => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'recent-item';
      itemDiv.innerHTML = `
        <div class="recent-info">
            <div>${r.name}</div>
            <div>${r.vpa}</div>
        </div>
        <button class="btn btn-secondary" style="width:auto; padding: 6px 12px; font-size: 12px;" onclick="payAgain('${r.vpa}', '${r.name}')">Pay</button>
      `;
      list.appendChild(itemDiv);
    });
  }

  window.payAgain = function(vpa, name) {
    openPayModal();
    document.getElementById('payUpiId').value = vpa;
    document.getElementById('payTo').value = name;
    document.getElementById('paymentAppsSection').style.display = 'block';
    document.getElementById('payBtnAction').style.display = 'none';
    setTimeout(() => document.getElementById('payAmount').focus(), 100);
  }

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === 'visible' && window.paymentPending) {
      const timeSpent = Date.now() - window.paymentPending;
      window.paymentPending = false;
      if (timeSpent > 2000) {
        setTimeout(() => {
            overlay.classList.add('active');
            document.getElementById('paymentConfirmModal').classList.add('active');
        }, 500);
      }
    }
  });

  window.handleFileScan = async function(input) {
    if (!input.files || !input.files[0]) return;
    const file = input.files[0];
    // Use a dedicated hidden element for file scanning to avoid conflicts
    const fileScanner = new Html5Qrcode("file-qr-reader");
    try {
        const decodedText = await fileScanner.scanFile(file, false);
        onScanSuccess(decodedText);
    } catch (err) {
        console.error("File scan error:", err);
        alert("No QR code found in image");
    } finally {
        try { await fileScanner.clear(); } catch(e) {}
    }
    input.value = '';
  }

  // =====================================================
  // EVENT BINDINGS
  // =====================================================
  document.getElementById("startBillBtn").addEventListener("click", () => startCamera("bill"));
  document.getElementById("switchBillCamBtn").addEventListener("click", switchBillCamera);
  document.getElementById("captureBillBtn").addEventListener("click", captureBillAndProcess);
  document.getElementById("saveBillToExpensesBtn").addEventListener("click", saveBillToExpenses);
  document.getElementById("clearBillPreviewBtn").addEventListener("click", clearBillPreview);
  
  const deleteBtn = document.getElementById("deleteAllMomentsBtn");
  if (deleteBtn) deleteBtn.addEventListener("click", deleteAllMomentsHandler);

  document.getElementById("startMomentBtn").addEventListener("click", () => startCamera("moment"));
  document.getElementById("switchMomentCamBtn").addEventListener("click", switchMomentCamera);
  document.getElementById("captureMomentBtn").addEventListener("click", captureMoment);
  document.getElementById("toggleMirrorBtn").addEventListener("click", () => {
    const isMirrored = momentVideo.classList.toggle("mirror-video");
    const btn = document.getElementById("toggleMirrorBtn");
    if (isMirrored) {
      btn.classList.remove("btn-secondary");
      btn.classList.add("btn-primary");
    } else {
      btn.classList.remove("btn-primary");
      btn.classList.add("btn-secondary");
    }
  });
  
  // Init for Scan & Pay
  if(document.getElementById('payUpiId')) {
      document.getElementById('payUpiId').addEventListener('input', updateFavBtnState);
  }
  overlay.addEventListener('click', () => {
    closePayModal();
    closeQrScanner();
  });

  // INITIALIZE
  renderMoments();
  loadPaymentSettings().then(() => { renderUpiFavorites(); });
  renderRecentPayments();

  // Open QR Scanner by default
  setTimeout(() => openQrScanner('direct'), 300);
</script>
<script src="translations.js"></script>
</body>
</html>
